                                         load data.mat
%输入参数
M=6;               %The total number of states
K=6;               %The total number of observation values
T=300;               %The length of the observation sequence
        %The observation sequence
O=[1,2,4,5,6,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1,2,4,1,2,4,5,1,2,6,4,5,6,3,1,2,5,6,4,1,2,5,4,6,3,1,2,5,6,4,3,1,2,1,2,5,6,4,3,1,5,2,5,6,6,4,1,2,2,2,3,3,3,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,2,2,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1,2,4,1,2,4,5,1,2,6,4,5,6,3,1,2,5,6,4,1,2,5,4,6,3,1,2,5,6,4,3,1,2,1,2,5,6,4,3,1,5,2,5,6,6,4,1,2,4,5,6,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1];
%Oth=[1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,3,1,2,3,3,3,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,2,3,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,2,3,3,3];
Oth=[1,2,4,5,6,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1,2,4,1,2,4,5,1,2,6,4,5,6,3,1,2,5,6,4,1,2,5,4,6,3,1,2,5,6,4,3,1,2,1,2,5,6,4,3,1,5,2,5,6,6,4,1,2,4,5,6,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1,2,4,1,2,4,5,1,2,6,4,5,6,3,1,2,5,6,4,1,2,5,4,6,3,1,2,5,6,4,3,1,2,1,2,5,6,4,3,1,5,2,5,6,6,4,1,2,4,5,6,3,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,4,5,6,3,1,2,1,2,4,4,5,5,6,6,1,2,4,1,2,4,5,6,3,1,2,5,6,3,4,1,2,4,1,2,4,5,6,5,6,3,1,2,4,1,2,4,5];
%O1=[1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,1,1,1,1,1,2,3,3,3,3,4,5,6,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3];
%O1=[1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,3,1,1,1,1,2,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,2,3,3,3,3,3,3,3,4,5,6,3,3,3,3,1,1,1,1,3];
O1=[1,2,2,1,2,2,1,2,2,1,2,2,1,2,2,1,2,2,1,2,2,1,2,3,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,2,2,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,1,2,2,2,2,1,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,2,2,3,1,2,2,2,2,2,2,3,1,2,2,2,2,2,3,3,1,2,2,2,2,2,2,3];

O2=[1,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,2,2,2,2,2,2,2,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2,2,2,3,3,3,3,3,3,3,3,3,3,1,2];
O3=[1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,1,3,3,3,3];

W=20;
PAI=[56/300;
    59/300;
    38/300;
    51/300;
    48/300;
    48/300;];  
   %the initial probability of states

A=[1/100,53/55,1/100,1/100,2/55,1/100;
   6/57,2/57,1/57,33/57,13/57,2/57;
   29/37,1/100,5/37,3/37,1/100,1/100;
   15/51,1/100,4/51,3/51,27/51,2/51;
   2/48,2/48,1/100,2/48,3/48,39/48;
   3/48,1/100,27/48,10/48,3/48,5/48];    %The state Transition Probability Matrix

B=[1,0,0,0,0,0;
   0,1,0,0,0,0;
   0,0,1,0,0,0;
   0,0,0,1,0,0;
   0,0,0,0,1,0;
   0,0,0,0,0,1;];



%初始值

ALPHA=zeros(M,1); 
ALPHA1=zeros(M,1);%α中间变量; 
ALPHA(:,1)=PAI.*B(:,O(1));
for i=2:20
   for j=1:M
      ALPHA1(j)=sum(ALPHA.*A(:,j)); 
   end
   ALPHA=ALPHA1.*B(:,O(i));
   
end

y=hmm1_forward(M,T,O,PAI,A,B,W);
x1 = [1:1:280];
output1=y(x1);%正常序列的概率
figure;
plot(x1,output1);%正常序列的概率图

% ymin=min(y);
% ymax=max(y);
% x2=linspace(ymin,ymax,10);
% yy=hist(y,x2);
% yy=yy/length(y);
% figure;
% bar(x2,yy,1.5);

y1=hmm1_forward(M,T,O1,PAI,A,B,W);
x3 = [1:1:280];
output2=y1(x3);%异常序列的概率
figure;
plot(x1,output1,x3,output2);%异常序列的概率图
xlabel('观测序列')
ylabel('对数似然值')
legend('Normal','DDoS')
% ymin1=min(y1);
% ymax1=max(y1);
% x4=linspace(ymin1,ymax1,10);
% yy1=hist(y1,x4);
% yy1=yy1/length(y1);
% 
% figure;
% bar(x4,yy1);





y2=hmm1_forward(M,T,O2,PAI,A,B,W);
x5 = [1:1:280];
output3=y2(x5);%异常序列的概率
figure;
plot(x1,output1,x5,output3);%异常序列的概率图


y3=hmm1_forward(M,T,O3,PAI,A,B,W);
x7 = [1:1:280];
output3=y3(x7);%异常序列的概率
figure;
%plot(x1,output1,'*','Markersize',1,xt1,outputt1,'o','MarkerSize',1,x3,output2,'*','MarkerSize',1,xt3,outputt2,'o','MarkerSize',1,x7,output3,'*','MarkerSize',1,xt7,outputt3,'o','MarkerSize',1);%,'linewidth',1);%异常序列的概率图
plot(x1,output1,'-x',x3,output2,'-x',x7,output3,'-x',xt1,outputt1,'-o',xt3,outputt2,'-o',xt7,outputt3,'-o','MarkerSize',4);%,'linewidth',1);%异常序列的概率图
%plot(x1,output1,'-x',x3,output2,'-x',x7,output3,'-x');%,'linewidth',1);%异常序列的概率图
xlabel('观测序列')
ylabel('对数似然值')
legend('Normal','DDoS','Intercept','Normal-theory','DDoS-theory','Intercept-theory')


figure;
plot(xt1,outputt1,'-ob',x1,output1,'-r','MarkerSize',5);
xlabel('Serial number of sub-sequence');
ylabel('Observation probability');
grid on;
legend('Theoretical','Practical');
title('Normal system');

figure;
plot(xt3,outputt2,'-ob',x3,output2,'-r','MarkerSize',5);
xlabel('Serial number of sub-sequence');
ylabel('Observation probability');
grid on;
legend('Theoretical','Practical');
title('DoS attack');

figure;
plot(xt7,outputt3,'-ob',x7,output3,'-r','MarkerSize',5);
xlabel('Serial number of sub-sequence');
ylabel('Observation probability');
grid on;
legend('Theoretical','Practical');
title('Hijack attack');






a=[-90:0.01:0];
c=DR_FPR(y,a);

c1=DR_FPR(y1,a);
% disp(c1)
c2=DR_FPR(y2,a);

c3=DR_FPR(y3,a);
% disp(c3)

a=[-90:0.01:0-0.01];
bn=DR_FPR(y,a);
% disp(b)
b1=DR_FPR(y1,a);
% disp(b1)
figure;
R=1-bn;
P_=2-bn-b1;
P=R./(P_);
f1=(2.*P.*R)./(P+R);
[f1max1,index1]=max(f1);
% for i=1:length(P);
%     if P(i)<0.5;
%        P(i)=0.5; 
%     end
%    
% end
% c = polyfit(R, P, 25); %进行拟合，c为2次拟合后的系数
% d = polyval(c, R, 1); %拟合后，每一个横坐标对应的值即为d
% plot(R,P,'linewidth',2);
% set(gca,'XTick',[0:0.1:1]);%设置要显示坐标刻度
% set(gca,'YTick',[0:0.1:1]);%设置要显示坐标刻度
% xlabel('Recall')
% ylabel('Precision')
% legend('DDoS检测性能')
% set(gca,'YLim',[0 1.2]);%X轴的数据显示范围


%无误码的DDOS检测性能
yth=hmm1_forward(M,T,Oth,PAI,A,B,W);
bnth=DR_FPR(yth,a);
Rth=1-bnth;
Pth_=2-bnth-b1;
Pth=Rth./(Pth_);
outputth=yth(x1);
plot(x3,output2,x1,outputth);
% disp(outputth);

figure;
% c = polyfit(R, P, 9); %进行拟合，c为2次拟合后的系数
% disp(length(HMM_Rt1_))
% disp(length(HMM_Pt1_))
% d = polyval(c, R, 1); %拟合后，每一个横坐标对应的值即为d
% d(end-528:end)=1;
% d(end-529)=1.00001;
% figure;

% plot(HMM_Rt1_,HMM_Pt1_)
figure;
plot(HMM_Rt1_,HMM_Pt1_,'-ob',R,P,'-r',R2_,P2_,'--g','MarkerSize',5,'linewidth',1.5);
xlim([0 1]);
ylim([0.4 1.1]);
set(gca,'XTick',(0:0.1:1));%设置要显示坐标刻度
set(gca,'YTick',(0.4:0.1:1.1));%设置要显示坐标刻度
xlabel('$r_{\rm re}$','interpreter','latex','fontsize',15)
ylabel('$r_{\rm pr}$','interpreter','latex','fontsize',15)
legend('Theoretical HMM','Practical HMM','CUSUM')
grid on;
title('DoS detection performance')
HMM_R1_=R;
HMM_P1_=P;
% HMM_P1=d;


figure;
%P=P(500:1200);
%R=R(500:1200);
%v=a(500:1200);
%plot(v,P,v,R);
%set(gca,'YLim',[0 1.2]);%X轴的数据显示范围

plot(a,P,a,R)
plot(a,P,a,R,'linewidth',2)
xlabel('Threshold')
ylabel('Frequency')
legend('Precision','Recall')


b2=DR_FPR(y2,a);
% disp(b2)
figure;
R=1-bn;
P_=2-bn-b2;
P=R./(P_);


% c = polyfit(R, P, 25); %进行拟合，c为2次拟合后的系数
% d = polyval(c, R, 1); %拟合后，每一个横坐标对应的值即为d
plot(R,P,'linewidth',2);
set(gca,'XTick',[0:0.5:1]);%设置要显示坐标刻度
set(gca,'YTick',[0:0.1:1]);%设置要显示坐标刻度
xlabel('Recall')
ylabel('Precision')
legend('Falsification detection performance')
set(gca,'YLim',[0 1.2]);%X轴的数据显示范围
HMM_R2=R;
HMM_P2=P;

figure;
% P=P(500:1200);
% R=R(500:1200);
% v=a(500:1200);
% plot(v,P,v,R);
% set(gca,'YLim',[0 1.2]);%X轴的数据显示范围
plot(a,P,a,R,'linewidth',2)
xlabel('Threshold')
ylabel('Frequency')
legend('Precision','Recall')



b3=DR_FPR(y3,a);
% disp(b3)
figure;
R=1-bn;
P_=2-bn-b3;
P=R./(P_);


% c = polyfit(R, P, 25); %进行拟合，c为2次拟合后的系数
% d = polyval(c, R, 1); %拟合后，每一个横坐标对应的值即为dfigure;
c = polyfit(R, P, 6); %进行拟合，c为2次拟合后的系数
d = polyval(c, R,1); %拟合后，每一个横坐标对应的值即为d
d(end-520:end)=1;
d(end-521)=1.00001;
%% --SQ
HMM_Pt3(isnan(HMM_Pt3)) = 1;
P(isnan(P)) = 1;
%%
plot(HMM_Rt3,HMM_Pt3,'-ob',R,P,'-r',R3_,P3_,'--g','MarkerSize',5,'linewidth',1.5);
xlim([0 1]);
ylim([0.4 1.1]);
set(gca,'XTick',[0:0.1:1]);%设置要显示坐标刻度
set(gca,'YTick',[0.4:0.1:1.1]);%设置要显示坐标刻度
xlabel('$r_{\rm re}$','interpreter','latex','fontsize',15)
ylabel('$r_{\rm pr}$','interpreter','latex','fontsize',15)
legend('Theoretical HMM','Practical HMM','CUSUM')
grid on;
title('Intercept detection performance')
%set(gca,'YLim',[0 1.2]);%X轴的数据显示范围
HMM_R3=R;
HMM_P3=P;


figure;
% P=P(500:1200);
% R=R(500:1200);
% v=a(500:1200);
% plot(v,P,v,R);
% set(gca,'YLim',[0 1.2]);%X轴的数据显示范围
plot(a,P,a,R)
plot(a,P,a,R,'linewidth',2)
xlabel('Threshold')
ylabel('Frequency')
legend('Precision','Recall')


